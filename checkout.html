<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Cuchitas</title>
    <meta name="description" content="Finaliza tu pedido en Cuchitas.">

    <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header simplificado -->
    <header>
        <div class="header-container">
            <a href="/" class="logo">
                <img src="images/logo-cuchitas-header.webp" alt="Cuchitas" width="55" height="55" style="border-radius: 50%;">
            </a>
            <div style="color: white; display: flex; align-items: center; gap: 10px;">
                <span>üîí</span>
                <span>Pago Seguro</span>
            </div>
        </div>
    </header>

    <!-- Checkout Content -->
    <main class="checkout-page">
        <a href="carrito.html" style="color: var(--verde-oscuro); margin-bottom: 20px; display: inline-block;">
            ‚Üê Volver al carrito
        </a>

        <h1 style="margin-bottom: 30px;">Finalizar Pedido</h1>

        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 40px;">
            <!-- Formulario -->
            <div class="checkout-form">
                <h2 style="margin-bottom: 25px; font-size: 20px;">Datos de Env√≠o</h2>

                <form id="checkout-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre">Nombre *</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="apellidos">Apellidos *</label>
                            <input type="text" id="apellidos" name="apellidos" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="telefono">Tel√©fono *</label>
                            <input type="tel" id="telefono" name="telefono" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Direcci√≥n *</label>
                        <input type="text" id="direccion" name="direccion" placeholder="Calle, n√∫mero, piso..." required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cp">C√≥digo Postal *</label>
                            <input type="text" id="cp" name="cp" required>
                        </div>
                        <div class="form-group">
                            <label for="ciudad">Ciudad *</label>
                            <input type="text" id="ciudad" name="ciudad" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="provincia">Provincia *</label>
                        <select id="provincia" name="provincia" required>
                            <option value="">Selecciona provincia</option>
                            <option value="A Coru√±a">A Coru√±a</option>
                            <option value="√Ålava">√Ålava</option>
                            <option value="Albacete">Albacete</option>
                            <option value="Alicante">Alicante</option>
                            <option value="Almer√≠a">Almer√≠a</option>
                            <option value="Asturias">Asturias</option>
                            <option value="√Åvila">√Åvila</option>
                            <option value="Badajoz">Badajoz</option>
                            <option value="Barcelona">Barcelona</option>
                            <option value="Burgos">Burgos</option>
                            <option value="C√°ceres">C√°ceres</option>
                            <option value="C√°diz">C√°diz</option>
                            <option value="Cantabria">Cantabria</option>
                            <option value="Castell√≥n">Castell√≥n</option>
                            <option value="Ciudad Real">Ciudad Real</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cuenca">Cuenca</option>
                            <option value="Girona">Girona</option>
                            <option value="Granada">Granada</option>
                            <option value="Guadalajara">Guadalajara</option>
                            <option value="Guip√∫zcoa">Guip√∫zcoa</option>
                            <option value="Huelva">Huelva</option>
                            <option value="Huesca">Huesca</option>
                            <option value="Ja√©n">Ja√©n</option>
                            <option value="La Rioja">La Rioja</option>
                            <option value="Las Palmas">Las Palmas</option>
                            <option value="Le√≥n">Le√≥n</option>
                            <option value="Lleida">Lleida</option>
                            <option value="Lugo">Lugo</option>
                            <option value="Madrid">Madrid</option>
                            <option value="M√°laga">M√°laga</option>
                            <option value="Murcia">Murcia</option>
                            <option value="Navarra">Navarra</option>
                            <option value="Ourense">Ourense</option>
                            <option value="Palencia">Palencia</option>
                            <option value="Pontevedra">Pontevedra</option>
                            <option value="Salamanca">Salamanca</option>
                            <option value="Santa Cruz de Tenerife">Santa Cruz de Tenerife</option>
                            <option value="Segovia">Segovia</option>
                            <option value="Sevilla">Sevilla</option>
                            <option value="Soria">Soria</option>
                            <option value="Tarragona">Tarragona</option>
                            <option value="Teruel">Teruel</option>
                            <option value="Toledo">Toledo</option>
                            <option value="Valencia">Valencia</option>
                            <option value="Valladolid">Valladolid</option>
                            <option value="Vizcaya">Vizcaya</option>
                            <option value="Zamora">Zamora</option>
                            <option value="Zaragoza">Zaragoza</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notas">Notas del pedido (opcional)</label>
                        <textarea id="notas" name="notas" rows="3" placeholder="Instrucciones de entrega, alergias, etc."></textarea>
                    </div>

                    <h2 style="margin: 30px 0 25px; font-size: 20px;">M√©todo de Pago</h2>

                    <div style="background: var(--gris-claro); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="pago" value="transferencia" checked>
                            <span><strong>Transferencia Bancaria</strong> - Recibir√°s los datos por email</span>
                        </label>
                    </div>

                    <div style="background: var(--gris-claro); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="pago" value="bizum">
                            <span><strong>Bizum</strong> - Pago instant√°neo desde tu m√≥vil</span>
                        </label>
                    </div>

                    <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; border: 2px solid #4CAF50;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="pago" value="whatsapp">
                            <span><strong>üí¨ Confirmar por WhatsApp</strong> - Te contactamos para coordinar pago y env√≠o</span>
                        </label>
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 30px; justify-content: center;">
                        Confirmar Pedido ‚Üí
                    </button>
                </form>
            </div>

            <!-- Resumen del pedido -->
            <div>
                <div class="cart-summary" style="position: sticky; top: 100px;">
                    <h3>Tu Pedido</h3>

                    <div id="order-items" style="margin-bottom: 20px;">
                        <!-- Items del pedido -->
                    </div>

                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">0,00‚Ç¨</span>
                    </div>
                    <div class="summary-row">
                        <span>Env√≠o</span>
                        <span id="shipping">Calculando...</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total">0,00‚Ç¨</span>
                    </div>

                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gris-medio);">
                        <p style="font-size: 13px; color: #666;">
                            üîí Tus datos est√°n protegidos<br>
                            üì¶ Env√≠o en 24-48h laborables
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer simplificado -->
    <footer style="margin-top: 60px;">
        <div class="footer-bottom" style="border: none; padding: 30px;">
            ¬© 2026 Cuchitas ¬∑ Saben a M√©xico
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/cart.js"></script>
    <script>
        // Mobile menu
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const nav = document.querySelector('nav');
        if (mobileMenuBtn && nav) {
            mobileMenuBtn.addEventListener('click', () => {
                nav.classList.toggle('active');
                mobileMenuBtn.textContent = nav.classList.contains('active') ? '‚úï' : '‚ò∞';
            });
            nav.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    nav.classList.remove('active');
                    mobileMenuBtn.textContent = '‚ò∞';
                });
            });
        }

        // Configuraci√≥n Supabase
        const SUPABASE_URL = 'https://bcicjjkgjgajxbrwmeyf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjaWNqamtnamdhanhicndtZXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODU3ODIsImV4cCI6MjA4NDc2MTc4Mn0.BqgzIMTWvDIzbx1lofd7ZHYWt3FWjdpWc89kBaQGvrs';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const SHIPPING_CONFIG = {
            freeThreshold: 20,
            standardPrice: 4.90
        };

        const WHATSAPP_NUMBER = '34652600700';

        function renderOrderSummary() {
            // Redirigir si carrito vac√≠o
            if (window.cart.isEmpty()) {
                window.location.href = 'carrito.html';
                return;
            }

            const itemsEl = document.getElementById('order-items');
            itemsEl.innerHTML = window.cart.items.map(item => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                    <span>${item.name} √ó ${item.quantity}</span>
                    <span style="font-weight: 600;">${(item.price * item.quantity).toFixed(2)}‚Ç¨</span>
                </div>
            `).join('');

            const subtotal = window.cart.getSubtotal();
            const shipping = window.cart.getShipping(SHIPPING_CONFIG);
            const total = subtotal + shipping;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + '‚Ç¨';
            document.getElementById('shipping').textContent = shipping === 0 ? 'GRATIS' : shipping.toFixed(2) + '‚Ç¨';
            document.getElementById('total').textContent = total.toFixed(2) + '‚Ç¨';
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderOrderSummary();

            // Manejar env√≠o del formulario
            document.getElementById('checkout-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Procesando...';

                try {
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData);
                    const paymentMethod = formData.get('pago');

                    const subtotal = window.cart.getSubtotal();
                    const shipping = window.cart.getShipping(SHIPPING_CONFIG);
                    const total = subtotal + shipping;

                    // 1. Crear pedido en Supabase
                    const { data: order, error: orderError } = await supabase
                        .from('cuchitas_orders')
                        .insert({
                            customer_name: `${data.nombre} ${data.apellidos}`,
                            customer_email: data.email,
                            customer_phone: data.telefono,
                            shipping_address: data.direccion,
                            shipping_city: data.ciudad,
                            shipping_postal_code: data.cp,
                            shipping_province: data.provincia,
                            subtotal: subtotal,
                            shipping_cost: shipping,
                            total: total,
                            payment_method: paymentMethod,
                            notes: data.notas || null
                        })
                        .select()
                        .single();

                    if (orderError) throw orderError;

                    // 2. Insertar items del pedido
                    const orderItems = window.cart.items.map(item => ({
                        order_id: order.id,
                        product_id: item.id,
                        product_name: item.name,
                        product_image: item.image,
                        quantity: item.quantity,
                        unit_price: item.price,
                        total_price: item.price * item.quantity
                    }));

                    const { error: itemsError } = await supabase
                        .from('cuchitas_order_items')
                        .insert(orderItems);

                    if (itemsError) throw itemsError;

                    // 3. Guardar datos para p√°gina de gracias
                    sessionStorage.setItem('cuchitas_last_order', JSON.stringify({
                        id: order.id,
                        total: total,
                        email: data.email,
                        paymentMethod: paymentMethod
                    }));

                    // 4. Si es WhatsApp, abrir tambi√©n el chat
                    if (paymentMethod === 'whatsapp') {
                        const customerInfo = {
                            name: `${data.nombre} ${data.apellidos}`,
                            phone: data.telefono,
                            email: data.email,
                            address: `${data.direccion}, ${data.cp} ${data.ciudad}, ${data.provincia}`
                        };
                        window.open(window.cart.getWhatsAppLink(WHATSAPP_NUMBER, customerInfo), '_blank');
                    }

                    // 5. Vaciar carrito y redirigir
                    window.cart.clear();
                    window.location.href = 'gracias.html';

                } catch (error) {
                    console.error('Error al procesar pedido:', error);
                    alert('Hubo un error al procesar tu pedido. Por favor, int√©ntalo de nuevo o cont√°ctanos por WhatsApp.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Confirmar Pedido ‚Üí';
                }
            });
        });
    </script>
</body>
</html>
